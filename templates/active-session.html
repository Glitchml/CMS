<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ConferenceHub - Active Session</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css "/>
  <link rel="stylesheet" href="../static/sessions.css"/>
</head>
<body>
  <!-- Main content -->
  <main class="main-content">
    <div class="card">
      <!-- Add id to match JavaScript reference -->
      <h3 id="sessionTitle" class="card-title"><i class="fas fa-video"></i> Loading...</h3>

      <div style="margin-bottom: 1rem; text-align: center;">
        <!-- Change id to match JavaScript reference -->
        <h4 id="sessionTimeCountdown" class="card-title" style="color: #357AFF;">
          <i class="fas fa-clock"></i> Time Remaining: --:--
        </h4>
      </div>

      <!-- Add session description element -->
      <p id="sessionDescription" class="session-description"></p>

      <div class="session-layout">
        <div>
          <div class="qa-section">
            <h4 class="card-title"><i class="fas fa-question-circle"></i> Ask a Question</h4>
            <form id="questionForm" class="session-form">
              <div class="form-group">
                <label class="input-label">Your Name (optional)</label>
                <input type="text" class="input" placeholder="Enter your name (optional)" id="userName"/>
              </div>
              <div class="form-group">
                <label class="input-label">Your Question</label>
                <textarea class="input" rows="4" id="userQuestion" placeholder="Type your question here..."></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Submit Question</button>
            </form>
          </div>

          <!-- Add questions container that's referenced in JavaScript -->
          <div id="questionsContainer" class="questions-container"></div>

          <!-- Add data attributes for API endpoints -->
          <div class="session-controls" data-leave-endpoint="/api/session/leave">
            <button class="control-button">
              <i class="fas fa-desktop"></i>
              <span>Share</span>
            </button>
            <button class="control-button">
              <i class="fas fa-phone-slash"></i>
              <span>Leave</span>
            </button>
          </div>
        </div>

        <!-- Add data attribute and correct id -->
        <div class="card participant-list" data-participants-endpoint="/api/session/{sessionId}/participants">
          <h4 class="card-title"><i class="fas fa-users"></i> Participants (<span id="participantCount">0</span>)</h4>
          <!-- Replace static participants with dynamic list -->
          <div id="participantList" class="participants-container">
            <!-- Participants will be loaded dynamically -->
          </div>
        </div>
      </div>

      <!-- Add error message container -->
      <div id="errorMessages" class="error-container" style="display: none;"></div>
    </div>
  </main>


  <script>
    const sessionId = new URLSearchParams(window.location.search).get('id') || 'ses_123';
    let ws;

    // Load session details on page load
    window.addEventListener('DOMContentLoaded', () => {
      fetch(`/api/session/${sessionId}`)
        .then(res => res.json())
        .then(data => renderSessionDetails(data))
        .catch(err => console.error('Failed to load session:', err));

      fetch(`/api/session/${sessionId}/participants`)
        .then(res => res.json())
        .then(participants => renderParticipants(participants))
        .catch(err => console.error('Failed to load participants:', err));
      
      setupWebSocket();
    });

    function renderSessionDetails(session) {
      document.getElementById('sessionTitle').textContent = session.title;
      document.getElementById('sessionDescription').textContent = session.description;
      startCountdown(session.startTime, session.duration);
    }

    function renderParticipants(participants) {
      const list = document.getElementById('participantList');
      list.innerHTML = '';
      if (participants.length === 0) {
        list.innerHTML = '<li>No participants yet.</li>';
        return;
      }
      participants.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name} (${p.role})`;
        list.appendChild(li);
      });
    }

    function startCountdown(startTime, durationMinutes) {
      const endTime = new Date(startTime);
      endTime.setMinutes(endTime.getMinutes() + durationMinutes);

      function updateCountdown() {
        const now = new Date();
        const diff = endTime - now;
        if (diff <= 0) {
          clearInterval(timer);
          document.getElementById('sessionTimeCountdown').textContent = "Session has ended.";
          return;
        }

        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        document.getElementById('sessionTimeCountdown').textContent = `Remaining time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      }

      updateCountdown();
      const timer = setInterval(updateCountdown, 1000);
    }

    // Handle question submission
    document.getElementById('questionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = document.getElementById('userName').value.trim();
      const question = document.getElementById('userQuestion').value.trim();

      if (!question) {
        alert("Please enter a question.");
        return;
      }

      try {
        const res = await fetch('/api/session/question', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ sessionId, name, question })
        });

        if (res.ok) {
          alert("Your question has been submitted!");
          document.getElementById('userQuestion').value = '';
        } else {
          alert("Failed to submit question.");
        }
      } catch (err) {
        console.error("Error submitting question:", err);
        alert("Could not submit your question at this time.");
      }
    });

    // Leave session handler
    document.querySelector('.control-button:nth-child(2)').addEventListener('click', async () => {
      if (confirm("Are you sure you want to leave this session?")) {
        try {
          await fetch('/api/session/leave', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ sessionId })
          });
          window.close(); // Or redirect to dashboard
        } catch (error) {
          console.error('Failed to leave session:', error);
        }
      }
    });

    // WebSocket for real-time updates
    function setupWebSocket() {
      ws = new WebSocket(`wss://localhost:5000/ws/session/${sessionId}`);

      ws.onopen = () => {
        console.log('WebSocket connected');
      };

      ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          switch(message.type) {
            case 'new_question':
              addQuestion(message.question);
              break;
            case 'participant_joined':
              addParticipant(message.participant);
              break;
            case 'session_end':
              document.getElementById('sessionTimeCountdown').textContent = "Session has ended.";
              break;
            default:
              console.log('Unknown message type:', message.type);
          }
        } catch (e) {
          console.error('Message parsing error:', e);
        }
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected');
        setTimeout(setupWebSocket, 5000); // Reconnect logic
      };
    }

    function addQuestion(questionObj) {
      const container = document.getElementById('questionsContainer');
      const div = document.createElement('div');
      div.className = 'question-item';
      div.innerHTML = `
        <strong>${questionObj.name || 'Anonymous'}:</strong>
        <p>${questionObj.question}</p>
      `;
      container.appendChild(div);
    }

    function addParticipant(participant) {
      const list = document.getElementById('participantList');
      const li = document.createElement('li');
      li.textContent = `${participant.name} (${participant.role})`;
      list.appendChild(li);
    }

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const pageName = item.querySelector('span').textContent.toLowerCase();
        const routes = {
          dashboard: 'dashboard.html',
          networking: 'networking-page.html',
          profile: 'profile.html',
          sessions: 'sessions.html',
          settings: 'settings.html'
        };
        window.location.href = routes[pageName] || '#';
      });
    });
  </script>
</body>
</html>